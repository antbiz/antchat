<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta name="renderer" content="webkit" />
    <meta name="force-rendering" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0, viewport-fit=cover"
    />
    <title>AntChat</title>
    <link rel="stylesheet" href="//g.alicdn.com/chatui/sdk-v2/0.2.2/sdk.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="//g.alicdn.com/chatui/sdk-v2/0.2.2/sdk.js"></script>
    <script src="//g.alicdn.com/chatui/icons/0.2.7/index.js" async></script>
    <script>
      var bot = new ChatSDK({
        config: {
          navbar: {
            title: "AntChat",
          },
          robot: {
            avatar:
              "//gw.alicdn.com/tfs/TB1U7FBiAT2gK0jSZPcXXcKkpXa-108-108.jpg",
          },
          messages: [
            {
              type: "text",
              content: {
                text: "请问有什么可以帮您？",
              },
            },
          ],
        },
        requests: {
          history: function () {
            return {
              url: "/api/v1/visitor/history",
            };
          },
          send: function (msg) {
            return {
              url: "/api/v1/visitor/send",
              data: msg
            };
          },
        },
        makeSocket({ctx}) {
          const ws = new WebSocket(`ws://${document.location.host}/api/v1/visitor/chat?x-api-sid=${localStorage.getItem('x-api-sid') || ''}`);
          let queueMsgId;

          ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.num) {
              if (queueMsgId) {
                ctx.updateMessage(queueMsgId, {
                  type: 'system',
                  content: {
                    text: `当前客服人数已满，您前面还有 ${data.num} 人`,
                  },
                });
              } else {
                queueMsgId = '_queue_msg_id_';
                ctx.appendMessage({
                  id: queueMsgId,
                  type: 'system',
                  content: {
                    text: `当前客服人数已满，您前面还有 ${data.num} 人`,
                  },
                });
              }
              return;
            }

            ctx.deleteMessage(queueMsgId);

            ctx.appendMessage(data);
          }
        }
      });

      bot.run();
    </script>
  </body>
</html>
